{% extends template %}

{% block head %}

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

<script>
	function validURL(u) {
		if(u.match("^[-A-Za-z0-9._~:/?#@!$&'()*+,;=% \\[\\]]+$"))
			return true;
		return false;
	};

	function checkURL(u) {
		if(!validURL(u))
		{
			alert('Invalid URL: ' + u);
			return false;
		}

		return true;
	}

	var linkmap = {};
	{% for i in page.links %}
		linkmap["_link_{{ loop.index0 }}_url"] = '{{ i|linkmap }}';
	{% endfor %}
	function linkCheck(v, i) {
		if(linkmap[i] == v)
			return 'checked';
		return '';
	}

	var savemap = {};
	function save() {
		if(!$.isEmptyObject(savemap))
		{
			$("#save").text('saving...');
			var m = savemap;
			backup = m;
			savemap = {};

			$.post('{{ "save"|url(pagekey=page.key.urlsafe()) }}', m, function(data, textStatus, jqXHR) {
				$('#save').html('&nbsp;');
				$('#saved').show().fadeOut(1000);
			});
		}
		else
		{
			$('#saved').show().fadeOut(1000);
		}
	}

	$(function() {
		var backup;

		$('body').prepend(
			'<div class="toolbar">' +
				'<span id="save">&nbsp;</span>' +
				' <span id="saved" style="display: none">saved</span>' +
				' <span id="error" style="display: none"><b>error</b></span>' +
			'</div>'
		);

		$('#save').ajaxError(function() {
			$(this).text('save');
			$('#error').show().fadeOut(4000);
			$.extend(savemap, backup);
		});

		// text

		$(".editable.text").each(function() {
			var i = this.id + "_text";
			var f = this.id + "_focus";
			var d = this.id + "_div";
			var h = '<div class="modal" id="' + d + '">' +
				'<p><label for="text">Text</label>' +
				'<input type="text" size="30" class="' + f + '" name="' + i + '" id="' + i + '" value="' + $(this).text() + '" /></p>' +
				'<p><a class="close text" href="#">save</a> <a href="#" class="cancel">cancel</a></p></div>';
			$(this).after(h);
		});

		$(".close.text").live('click', function() {
			var i = $(this).parents("div").first().prev();
			var t = $("#" + i[0].id + "_text");

			if(t[0].value)
			{
				i.text(t[0].value);
				savemap[i[0].id] = i.html();
				$(this).parents(".modal").hide();
				save();
			}

			return false;
		});

		// social

		socialmap = {};
		socialmap["facebook"] = "{{ site.facebook|default('', true) }}";
		socialmap["twitter"] = "{{ site.twitter|default('', true) }}";
		socialmap["youtube"] = "{{ site.youtube|default('', true) }}";
		socialmap["flickr"] = "{{ site.flickr|default('', true) }}";
		socialmap["linkedin"] = "{{ site.linkedin|default('', true) }}";
		socialmap["google"] = "{{ site.google|default('', true) }}";

		$(".editable.social").each(function() {
			var i = "social";
			var d = "social_div";
			var h = '<div class="modal" style="color: black" id="' + d + '">' +
				'<p>Facebook: <input type="text" size="45" id="' + i + '_facebook" value="' + socialmap["facebook"] + '" /></p>' +
				'<p>Twitter: <input type="text" size="45" id="' + i + '_twitter" value="' + socialmap["twitter"] + '" /></p>' +
				'<p>YouTube: <input type="text" size="45" id="' + i + '_youtube" value="' + socialmap["youtube"] + '" /></p>' +
				'<p>flickr: <input type="text" size="45" id="' + i + '_flickr" value="' + socialmap["flickr"] + '" /></p>' +
				'<p>Linkedin: <input type="text" size="45" id="' + i + '_linkedin" value="' + socialmap["linkedin"] + '" /></p>' +
				'<p>Google+: <input type="text" size="45" id="' + i + '_google" value="' + socialmap["google"] + '" /></p>' +
				'<p><a class="close social" style="color: black" href="#">save</a> <a href="#" style="color: black" class="cancel">cancel</a></p></div>';
			$(this).after(h);
		});

		$(".close.social").live('click', function() {
			$.each(socialmap, function(k, v) {
				var i = $("#social_" + k)[0];
				if(!i.value || checkURL(i.value))
				{
					savemap["_" + k] = i.value;
				}
			});

			$(this).parents(".modal").hide();
			save();
			return false;
		});

		// link

		$(".editable.link").each(function() {
			var i = this.id + "_url";
			var t = this.id + "_text";
			var f = this.id + "_focus";
			var d = this.id + "_div";

			var v = '';
			if(linkCheck('url', i))
				v = this.name;

			var h = '<div class="modal" id="' + d + '">' +
				'<p>Text: ' +
				'<input type="text" size="45" class="' + f + '" name="' + t + '" id="' + t + '" value="' + $(this).text() + '" /></p>' +
				'<p>Link:</p>' +
				'<br><input type="radio" name="' + i + '" value="url" ' + linkCheck('url', i) + '><input type="text" id="' + i + '_val" value="' + v + '">' +
				{% for k, v in pages.items() %}
					'<br><input type="radio" name="' + i + '" value="page:{{ k.id() }}" ' + linkCheck('page:{{ k.id() }}', i) + '> {{ v.name }}' +
				{% endfor %}
				'<p><a class="close link" href="#">save</a> <a href="#" class="cancel">cancel</a></p></div>';
			$(this).after(h);
		});

		$(".close.link").live('click', function() {
			var d = $(this).parents("div").first();
			var i = d.prev();
			var v = $("#" + i[0].id + "_url_val");
			var t = $("#" + i[0].id + "_text");
			var c = $('input[name=' + i[0].id + '_url]:radio:checked');

			if(c[0].value != 'url' || checkURL(v[0].value))
			{
				var url;
				if(c[0].value == 'url')
					url = v[0].value;
				else
					url = c[0].value;

				i.text(t[0].value);
				savemap[t[0].id] = i.html();
				savemap[i[0].id + "_url"] = url;
				$(this).parents(".modal").hide();
				save();
			}

			return false;
		});

		// all

		$(".editable").live('click', function() {
			$('#' + this.id + '_div').show();
			$("." + this.id + "_focus").focus();
			return false;
		});

		$(".cancel").live('click', function() {
			$(this).parents(".modal").hide();
			return false;
		});

		$(document).keyup(function(e){
			if(e.keyCode == 27)
				$(".modal").hide();
		});
	});
</script>

<style media="screen" type="text/css">
	.editable {
		border: 2px solid yellow;
	}
	.modal {
		background: white;
		z-index: 1000;
		border: 2px solid red;
		display: none;
		position: absolute;
	}
</style>

{% endblock %}
