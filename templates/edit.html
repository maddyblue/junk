{% extends template %}

{% block html %} ng-app ng-controller="TNMCtrl"{% endblock %}

{% block head %}

{{ jquery_ui }}

<link rel="stylesheet" href="/static/css/edit.css" type="text/css">

<script type="text/javascript">

$(function() {
	TNM = {};

	TNM.pages = {
	{% for p in site.pages %}
		'{{ p.id() }}': "{{ pages[p].name }}"
		{%- if not loop.last %},{% endif %}
	{%- endfor %}
	};

	TNM.socialmap = {};
	TNM.social_media = [];

	{% for k, n in site.social_media %}
	TNM.socialmap["{{ k }}"] = "{{ site[k]|default('', true) }}";
	TNM.social_media.push(["{{ k }}", "{{ n }}"]);
	{% endfor %}

	{% if page.type != 'gallery' %}
	TNM.imageurls = {};
	{% for i in images %}
	TNM.imageurls["_image_{{ loop.index0 }}"] = {
		orig: "{{ i.orig|default('', true) }}",
		url: "{{ i.url|default('', true) }}",
		portw: {{ i.width }},
		porth: {{ i.height }},
		basew: {{ i.ow|default(0) }},
		baseh: {{ i.oh|default(0) }},
		x: {{ i.x|default(0) }},
		y: {{ i.y|default(0) }},
		s: {{ i.s|default(0) }},
		basetop: $("#_image_{{ loop.index0 }}").offset().top,
		baseleft: $("#_image_{{ loop.index0 }}").offset().left,
		wscale: 0,
		hscale: 0,
		min_scale: 0,
		max_scale: 0
	};
	{% endfor %}
	{% endif %}

	{% if page.type == 'blog' and pagenum %}
	{% set b = page.get_blogpost(pagenum) %}
	TNM.postdate = new Date('{{ b.date }}');

	{% set i = b.image.get() %}
	{% set id = '_postimage_%s' %pagenum %}
	TNM.imageurls["{{ id }}"] = {
		orig: "{{ i.orig|default('', true) }}",
		url: "{{ i.url|default('', true) }}",
		portw: {{ i.width }},
		porth: {{ i.height }},
		basew: {{ i.ow|default(0) }},
		baseh: {{ i.oh|default(0) }},
		x: {{ i.x|default(0) }},
		y: {{ i.y|default(0) }},
		s: {{ i.s|default(0) }},
		basetop: $("#{{ id }}").offset().top,
		baseleft: $("#{{ id }}").offset().left,
		wscale: 0,
		hscale: 0,
		min_scale: 0,
		max_scale: 0
	};
	{% endif %}

	TNM.existingimgs = {};
	{% for i in all_images %}
	TNM.existingimgs['{{ i.key.id() }}'] = {
		name: '{{ i.name }}',
		url: '{{ i.url }}',
		width: {{ i.width }},
		height: {{ i.height }},
		id: {{ i.key.id() }}
	};
	{% endfor %}

	TNM.pagelinks = {
	{% for i in page.links %}
		{% set idx = loop.index0 %}
		'_link_{{ idx }}': "{{ i }}"
		{%- if not loop.last %},{% endif %}
	{% endfor %}
	};

	TNM.image_to_link = {
	{% for i in page.links %}
		'_image_{{ loop.index0 }}': '_link_{{ loop.index0 }}'
		{%- if not loop.last %},{% endif %}
	{% endfor %}
	};

	TNM.current_layout = '{{ page.layout }}';
	TNM.layouts = {};
	{% for i in range(1, page.layouts + 1) %}
		TNM.layouts['{{ i }}'] = {
			url: "{{ "layout"|url(siteid=site.key.id(), pageid=page.key.id(), layoutid=i) }}",
			img: "/static/images/layouts/{{ site.theme }}/{{ page.type }}-{{ i }}.png"
		};
	{% endfor %}

	TNM.current_color = '{{ site.color }}';
	TNM.colors = [];
	{% for i in site.colors %}
		TNM.colors.push({
			name: "{{ i }}",
			url: "{{ "colors"|url(siteid=site.key.id(), color=i) }}",
			img: "/static/images/colors/{{ site.theme }}/{{ i }}.png"
		});
	{% endfor %}

	TNM.newpagetypes =
		{% for t, layouts in site.types|dictsort %}
			{% for l in layouts %}
				'<option value="{{ t }}:{{ l }}">{{ t }} ({{ l }})</option>' +
			{% endfor %}
		{% endfor %}
		'';

	TNM.archivepages =
		{% for p in site.archived_pages %}
			'<option value="{{ p.key.id() }}">{{ p.name }}</option>' +
		{% endfor %}
		'';

	TNM.newpageurl = '{{ "new-page"|url }}';
	TNM.archivepageurl = '{{ "archive-page"|url }}';
	TNM.unpublishpageurl = '{{ "unpublish-page"|url(pageid=page.key.id()) }}';

	TNM.publishedurl = '{{ published_url }}';
	TNM.publishurl = '{{ publish_url }}';
	TNM.saveurl = '{{ "save"|url(siteid=site.key.id(), pageid=page.key.id()) }}';
	TNM.viewurl = '{{ view_url }}';
	TNM.uploadurl = '{{ upload_url }}';
	TNM.domain = '{{ site.domain|default('', True) }}';
	TNM.gravatar = '{{ user.gravatar }}';
	TNM.name = '{{ user.name }}';
});

</script>

<script src="/static/js/site.min.js"></script>
<script src="/static/js/edit.js"></script>

<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular.min.js"></script>

<link rel="stylesheet" type="text/css" href="/gae_mini_profiler/static/css/profiler.css" />
<script type="text/javascript" src="/gae_mini_profiler/static/js/profiler.js"></script>
<script type="text/javascript">GaeMiniProfiler.init(jQuery.cookiePlugin('MiniProfilerId'), false)</script>

{% endblock %}
