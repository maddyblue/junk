function validURL(a){return a.match("^[-A-Za-z0-9._~:/?#@!$&'()*+,;=% \\[\\]]+$")?!0:!1}function checkURL(a){return validURL(a)?!0:(alert("Invalid URL: "+a),!1)}function linkCheck(a,b){return $.tnm.linkmap[b]==a?"checked":""}function save(){if(!$.isEmptyObject(savemap)){$("#save").text("saving...");var a=savemap;backup=a,savemap={},$.post($.tnm.saveurl,a,function(a,b,c){var d=jQuery.parseJSON(a);d.errors.length>0?alert(d.errors):$.each(d,function(a,b){var c=!1;$.each(b,function(b,d){$.tnm.imageurls[a][b]=d,b=="url"&&($("#"+a)[0].src=d),b=="orig"&&(c=!0)}),c&&($("#containerimg").css("background-image","url("+$.tnm.imageurls[a].orig+")"),loadimg(a),resize(0,{value:0}))}),$("#save").html("&nbsp;"),$("#saved").show().fadeOut(1e3)})}else $("#saved").show().fadeOut(1e3)}function loadimg(a){var b=$.tnm.imageurls[a];b.wscale=b.portw/b.basew,b.hscale=b.porth/b.baseh,b.min_scale=Math.max(b.wscale,b.hscale),b.max_scale=Math.max(b.min_scale*3),b.s=Math.max(b.min_scale,b.s),b.s=Math.min(b.max_scale,b.s),$("#imgslider").slider("destroy"),$("#imgslider").slider({orientation:"vertical",min:b.min_scale,max:b.max_scale,step:(b.max_scale-b.min_scale)/100,slide:resize,value:b.s}),$("#containerimg").css("left",b.x),$("#containerimg").css("top",b.y)}function resize(a,b){var c=$.tnm.imageurls[cur_img],d=c.wscale,e=c.hscale,f=c.min_scale,g=c.max_scale,h=Math.max(c.min_scale,b.value);h=Math.min(c.max_scale,h);var i=c.basew*h,j=c.baseh*h,k=c.portw,l=c.porth,m=c.basetop,n=c.baseleft,o=.8;$("#containerimg").css({height:j,width:i}),$("#leftcontainer").css({width:i-k,height:l,top:j-l}),$("#rightcontainer").css({width:i-k,height:l,top:j-l}),$("#topcontainer").css({width:2*i-k,height:j-l}),$("#bottomcontainer").css({width:2*i-k,height:j-l}),$("#imgslider").css({top:j-l*(o+1)/2,left:i-20,height:l*o}),$("#imgcontainer").css({width:2*i-k,height:2*j-l,top:m+l-j,left:n+k-i});var p=$("#containerimg").position();p.left+i>2*i-k&&$("#containerimg").css({left:i-k}),p.top+j>2*j-l&&$("#containerimg").css({top:j-l}),c.x=p.left,c.y=p.top,c.s=h}var savemap={},cur_img;$(function(){function b(){$("#imgcontainer").remove()}var a;$("body").prepend('<div class="toolbar"><span id="save">&nbsp;</span> <span id="saved" style="display: none">saved</span> <span id="error" style="display: none"><b>error</b></span> <a id="view" href="'+$.tnm.viewurl+'">view</a>'+' <a id="publish" href="#">publish</a>'+' <a href="'+$.tnm.publishedurl+'">published</a>'+' <span style="border: 1px solid black">'+'domain: <input type="text" id="domain" value="'+$.tnm.domain+'">'+' <a id="save_domain">save</a>'+"</span>"+' <span id="publishing" style="display: none">publishing...</span>'+' <span id="layouts" style="border: 1px solid black">page layout:'+$.tnm.layouts+"</span>"+' <a id="new_page" href="#">new page</a>'+'<div class="modal" id="new_page_modal"><form method="POST" action="'+$.tnm.newpageurl+'">'+'title: <input type="text" name="title">'+'type: <select name="type">'+$.tnm.newpagetypes+"</select>"+'<input type="submit" value="create">'+'<a href="#" class="cancel">cancel</a>'+"</form></div>"+' <a id="del_page" href="#">del page</a>'+"</div>"),$("#save").ajaxError(function(){$(this).text("save"),$("#error").show().fadeOut(4e3),$.extend(savemap,a)}),$(document).on("click","#publish",function(){return $.ajax({url:$.tnm.publishurl}),$("#publishing").show().fadeOut(4e3),!1}),$(document).on("click","#new_page",function(){return $("#new_page_modal").show(),!1}),$(document).on("click","#save_domain",function(){savemap._domain=$("#domain").val(),save()}),$("#menu").sortable({items:".menu_item",stop:function(a,b){savemap.pos=$(this).sortable("toArray").join(","),save()}}),$(".editable.text").hallo({plugins:{halloformat:{},hallolink:{}}}),$(document).on("hallodeactivated",".editable.text",function(){savemap[this.id]=$(this).html(),save()}),$(".editable.line").each(function(){var a=this.id+"_text",b=this.id+"_focus",c=this.id+"_div",d='<div class="modal" id="'+c+'">'+'<p><label for="text">Text</label>'+'<input type="text" size="30" class="'+b+'" name="'+a+'" id="'+a+'" value="'+$(this).text()+'" /></p>'+'<p><a class="close line" href="#">save</a> <a href="#" class="cancel">cancel</a></p></div>';$(this).after(d)}),$(document).on("click",".close.line",function(){var a=$(this).parents("div").first().prev(),b=$("#"+a[0].id+"_text");return b[0].value&&(a.text(b[0].value),savemap[a[0].id]=a.html(),$(this).parents(".modal").hide(),save()),!1}),$(".editable.social").each(function(){var a="social",b="social_div",c='<div class="modal" style="color: black" id="'+b+'">'+'<p>Facebook: <input type="text" size="45" id="'+a+'_facebook" value="'+$.tnm.socialmap.facebook+'" /></p>'+'<p>Twitter: <input type="text" size="45" id="'+a+'_twitter" value="'+$.tnm.socialmap.twitter+'" /></p>'+'<p>YouTube: <input type="text" size="45" id="'+a+'_youtube" value="'+$.tnm.socialmap.youtube+'" /></p>'+'<p>flickr: <input type="text" size="45" id="'+a+'_flickr" value="'+$.tnm.socialmap.flickr+'" /></p>'+'<p>Linkedin: <input type="text" size="45" id="'+a+'_linkedin" value="'+$.tnm.socialmap.linkedin+'" /></p>'+'<p>Google+: <input type="text" size="45" id="'+a+'_google" value="'+$.tnm.socialmap.google+'" /></p>'+'<p><a class="close social" style="color: black" href="#">save</a> <a href="#" style="color: black" class="cancel">cancel</a></p></div>';$(this).after(c)}),$(document).on("click",".close.social",function(){return $.each($.tnm.socialmap,function(a,b){var c=$("#social_"+a)[0];if(!c.value||checkURL(c.value))savemap["_"+a]=c.value}),$(this).parents(".modal").hide(),save(),!1}),$(".editable.link").each(function(){var a=this.id+"_url",b=this.id+"_text",c=this.id+"_focus",d=this.id+"_div",e="";linkCheck("url",a)&&(e=this.name);var f='<div class="modal" id="'+d+'">'+"<p>Text: "+'<input type="text" size="45" class="'+c+'" name="'+b+'" id="'+b+'" value="'+$(this).text()+'" /></p>'+"<p>Link:</p>"+'<br><input type="radio" name="'+a+'" value="url" '+linkCheck("url",a)+'><input type="text" id="'+a+'_val" value="'+e+'">'+$.tnm.pagelinks[this.id]+'<p><a class="close link" href="#">save</a> <a href="#" class="cancel">cancel</a></p></div>';$(this).after(f)}),$(document).on("click",".close.link",function(){var a=$(this).parents("div").first(),b=a.prev(),c=$("#"+b[0].id+"_url_val"),d=$("#"+b[0].id+"_text"),e=$("input[name="+b[0].id+"_url]:radio:checked");if(e[0].value!="url"||checkURL(c[0].value)){var f;e[0].value=="url"?f=c[0].value:f=e[0].value,b.text(d[0].value),savemap[d[0].id]=b.html(),savemap[b[0].id+"_url"]=f,$(this).parents(".modal").hide(),save()}return!1}),$("a:has(img)").find(".editable.image").unwrap(),$(".editable.image").each(function(){var a=this.id+"_file",b=this.id+"_div",c=this.id+"_iframe",d=this.id+"_form",e=$.tnm.imageurls[this.id],f='<div class="modal" id="'+b+'">'+"<p>Upload ("+e.portw+"x"+e.porth+'): <form method="POST" id="'+d+'" target="'+c+'" enctype="multipart/form-data"><input type="file" id="'+a+'" name="'+a+'"></form><a class="upload image" href="#">upload</a></p>'+'<iframe id="'+c+'" src="#" style="width: 0; height: 0; border: 0px solid #fff;"></iframe>'+'<p>Existing: <select id="'+this.id+'_select">'+$.tnm.existingimgs+'</select> <a href="#" class="imgselect">use</a></p>'+'<p><a class="close image" href="#">save</a>'+' <a href="#" class="imgclear">clear</a>'+' <a href="#" class="cancel">cancel</a>'+"</p></div>";$(this).after(f)}),$(document).on("click",".close.image",function(){var a=$(this).parents("div").first(),c=a.prev(),d=$.tnm.imageurls[c[0].id];return resize(0,{value:d.s}),savemap[c[0].id+"_x"]=d.x,savemap[c[0].id+"_y"]=d.y,savemap[c[0].id+"_s"]=d.s,$(this).parents(".modal").hide(),b(),save(),!1}),$(document).on("click",".upload.image",function(){var a=$(this).parents("div").first(),b=a.prev(),c=$("#"+b[0].id+"_form");$.ajax({url:$.tnm.uploadurl+"?image="+b[0].id,success:function(a){c.attr("action",a),c.ajaxSubmit({success:function(a,c,d){if(a==""){alert("error during upload");return}var e=jQuery.parseJSON(a);b[0].src=e.url;var f=$.tnm.imageurls[b[0].id];f.url=e.url,f.orig=e.orig,f.basew=e.w,f.baseh=e.h,f.s=e.s,$("#containerimg").css("background-image","url("+f.orig+")"),loadimg(b[0].id),resize(0,{value:f.s})}})}})}),$(document).on("click",".editable.image",function(){b(),$(".modal").hide();var a='<div id="imgcontainer"><div id="topcontainer" class="containerdiv"></div><div id="leftcontainer" class="containerdiv"></div><span id="containerimg"></span><div id="imgslider"></div><div id="rightcontainer" class="containerdiv"></div><div id="bottomcontainer" class="containerdiv"></div></div>';$(this).before(a),cur_img=this.id;var c=$.tnm.imageurls[this.id];return $("#containerimg").draggable({containment:"parent"}),$("#containerimg").css("background-image","url("+c.orig+")"),loadimg(this.id),resize(0,{value:c.s}),!1}),$(document).on("click",".imgclear",function(){var a=$(this).parents("div").first(),c=a.prev();return $(this).parents(".modal").hide(),b(),savemap[c[0].id+"_c"]=!0,save(),!1}),$(document).on("click",".imgselect",function(){var a=$(this).parents("div").first(),b=a.prev(),c=$.tnm.imageurls[b[0].id];return savemap[b[0].id+"_b"]=$("#"+b[0].id+"_select")[0].value,save(),!1}),$(document).on("click",".editable",function(){return $("#"+this.id+"_div").show(),$("."+this.id+"_focus").focus(),!1}),$(document).on("click",".cancel",function(){return $(this).parents(".modal").hide(),b(),!1}),$(document).keyup(function(a){a.keyCode==27&&($(".modal").hide(),b())})});