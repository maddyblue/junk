function validURL(e){return e.match("^[-A-Za-z0-9._~:/?#@!$&'()*+,;=% \\[\\]]+$")?!0:!1}function checkURL(e){return validURL(e)?!0:(alert("Invalid URL: "+e),!1)}function linkCheck(e,t){return $.tnm.linkmap[t]==e?"checked":""}function loadimg(e){var t=$.tnm.imageurls[e];t.wscale=t.portw/t.basew,t.hscale=t.porth/t.baseh,t.min_scale=Math.max(t.wscale,t.hscale),t.max_scale=Math.max(t.min_scale*3),t.s=Math.max(t.min_scale,t.s),t.s=Math.min(t.max_scale,t.s),$("#imgslider").slider("destroy"),$("#imgslider").slider({orientation:"vertical",min:t.min_scale,max:t.max_scale,step:(t.max_scale-t.min_scale)/100,slide:resize,value:t.s}),$("#containerimg").css("left",t.x),$("#containerimg").css("top",t.y)}function resize(e,t){var n=$.tnm.imageurls[$.tnm.edit_image_id],r=n.wscale,i=n.hscale,s=n.min_scale,o=n.max_scale,u=Math.max(n.min_scale,t.value);u=Math.min(n.max_scale,u);var a=n.basew*u,f=n.baseh*u,l=n.portw,c=n.porth,h=n.basetop,p=n.baseleft,d=.8;h+=52,$("#containerimg").css({height:f,width:a}),$("#leftcontainer").css({width:a-l,height:c,top:f-c}),$("#rightcontainer").css({width:a-l,height:c,top:f-c}),$("#topcontainer").css({width:2*a-l,height:f-c}),$("#bottomcontainer").css({width:2*a-l,height:f-c}),$("#imgslider").css({top:f-c*(d+1)/2,left:a-20,height:c*d}),$("#imgcontainer").css({width:2*a-l,height:2*f-c,top:h+c-f,left:p+l-a}),$("#imgsave").css({top:f-c+5,right:a-l+3});var v=$("#containerimg").position();v.left+a>2*a-l&&$("#containerimg").css({left:a-l}),v.top+f>2*f-c&&$("#containerimg").css({top:f-c}),n.x=v.left,n.y=v.top,n.s=u}function make_dialog(e,t,n,r,i,s){s=s?s:"save",savebtn=i?'<a href="" class="btn save" ng-click="'+i+'()">'+s+"</a>":"";var o=$('<div class="dialog" id="'+e+'">'+'<div class="inner">'+'<div class="header">'+t+"</div>"+'<div class="content">'+'<div class="title">'+n+"</div>"+r+"</div>"+'<div class="buttons">'+savebtn+'<a href="" class="btn close">close</a>'+"</div>"+"</div>"+"</div>");return $(".btn.save",o).click(function(){o.hide()}),$(".btn.close",o).click(function(){o.hide()}),o.hide(),$("body").append(o),o.offset({left:o.outerWidth()/2}),o}function stopImageEdit(){$("#imgcontainer").hide()}function TNMCtrl(e,t){e.saves=0,e.savemap={},e.socialmap=$.tnm.socialmap,e.saved=function(){return e.saves?"saving...":"saved"},e.saveclass=function(){return e.saves?"saving":""},e.save=function(n){e.saves++,$.extend(n,e.savemap),t({method:"POST",url:$.tnm.saveurl,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(n)}).success(function(t){t.errors.length>0?alert(t.errors):$.each(t,function(e,t){var n=!1;$.each(t,function(t,r){$.tnm.imageurls[e][t]=r,t=="url"&&($("#"+e)[0].src=r),t=="orig"&&(n=!0)}),n&&($("#containerimg").css("background-image","url("+$.tnm.imageurls[e].orig+")"),loadimg(e),resize(0,{value:0}))}),e.saves--}).error(function(){$.extend(e.savemap,n),alert("error"),e.saves--})},e.save_social=function(){var t={};$.each(e.socialmap,function(e,n){var r=$("#social_"+e)[0];if(!r.value||checkURL(r.value))t["_"+e]=r.value}),e.save(t)},e.no_social=function(){var t=!0;return $.each(e.socialmap,function(e,n){n&&(t=!1)}),t},e.upload_image=function(){var e=$("#image_upload_form"),t=$.tnm.upload_image_id,n=$("#"+t)[0];$.ajax({url:$.tnm.uploadurl+"?image="+t}).done(function(r){e.attr("action",r),e.ajaxSubmit({success:function(r,s,o){if(!r){alert("error during upload");return}var u=$.parseJSON(r);n.src=u.url;var a=$.tnm.imageurls[t];a.url=u.url,a.orig=u.orig,a.basew=u.w,a.baseh=u.h,a.s=u.s,e[0].reset()}})})},e.imgsave=function(){var t=$.tnm.edit_image_id,n=$.tnm.imageurls[t];resize(0,{value:n.s});var r={};r[t+"_x"]=n.x,r[t+"_y"]=n.y,r[t+"_s"]=n.s,e.save(r),stopImageEdit()}}$(function(){$("body").prepend('<div id="toolbar"><nav class="left"><ul><li><a class="logo" href="/"><img src="/static/images/icon.png" /></a></li><li><a href="#" class="active btn">edit</a></li><li><a href="'+$.tnm.viewurl+'" class="btn">live view</a></li>'+'<li id="saved" ng-class="saveclass()">{{ saved() }}</li>'+"</ul></nav>"+'<nav class="divider"></nav>'+"<nav><ul>"+'<li><a class="publish btn" href="#">publish</a></li>'+'<li><a class="images btn" href="#">media</a></li>'+"</ul></nav>"+'<nav class="divider"></nav>'+"<nav><ul>"+'<li><a class="layout btn">layout</a></li>'+"</ul></nav>"+'<nav class="right"><ul class="user-actions">'+'<li><a href=""><img class="avatar" src='+$.tnm.gravatar+'" /></a></li>'+'<li class="user-info">'+'<span class="hello">Hello <span class="name">'+$.tnm.name+"</span></span>"+"<ul>"+'<li><a class="my-account" href="#">my account</a></li>'+'<li><a class="logout" href="/logout">logout</a></li>'+"</ul>"+"</li>"+"</ul></nav>"+"</div>");var e="";for(var t in $.tnm.layouts)t==$.tnm.current_layout?e+='<img src="'+$.tnm.layouts[t].img+'" class="current"/>':(e+='<a href="'+$.tnm.layouts[t].url+'">',e+='<img src="'+$.tnm.layouts[t].img+'"/>',e+="</a></li>");var n=make_dialog("layout_dialog","Page Layout","Choose page layout",e);$("#toolbar a.layout").click(function(){n.show()}),$("body").append('<div id="imgcontainer"><div id="imgsave" ng-click="imgsave()">save</div><div id="topcontainer" class="containerdiv"></div><div id="leftcontainer" class="containerdiv"></div><span id="containerimg"></span><div id="imgslider"></div><div id="rightcontainer" class="containerdiv"></div><div id="bottomcontainer" class="containerdiv"></div></div>'),$("#toolbar").show(),$(document).on("click","#publish",function(){return $.ajax({url:$.tnm.publishurl}),$("#publishing").show().fadeOut(4e3),!1}),$(document).on("click","#new_page",function(){return $("#new_page_modal").show(),!1}),$(document).on("click","#unpublish_page",function(){return $("#unpublish_page_modal").show(),!1}),$(document).on("click","#save_domain",function(){savemap._domain=$("#domain").val()}),$("#menu").sortable({items:".menu_item",stop:function(e,t){savemap.pos=$(this).sortable("toArray").join(",")}}),$(".editable.line").each(function(){var e=this.id+"_text",t=this.id+"_focus",n=this.id+"_div",r='<div class="modal" id="'+n+'">'+'<p><label for="text">Text</label>'+'<input type="text" size="30" class="'+t+'" name="'+e+'" id="'+e+'" value="'+$(this).text()+'" /></p>'+'<p><a class="close line" href="#">save</a> <a href="#" class="cancel">cancel</a></p></div>';$(this).after(r)}),$(document).on("click",".close.line",function(){var e=$(this).parents("div").first().prev(),t=$("#"+e[0].id+"_text");return t[0].value&&(e.text(t[0].value),savemap[e[0].id]=e.html(),$(this).parents(".modal").hide()),!1}),$(".editable.date").each(function(){var e=this.id+"_datepicker",t=this.id+"_div",n='<div class="modal" id="'+t+'">'+'<div type="text" id="'+e+'"></div>'+'<p><a class="close date" href="#">save</a> <a href="#" class="cancel">cancel</a></p></div>';$(this).after(n),$("#"+e).datepicker({dateFormat:"MM dd, yy",defaultDate:$.tnm.postdate})}),$(document).on("click",".close.date",function(){var e=$(this).parents("div").first().prev(),t=$("#"+e[0].id+"_datepicker");if(t[0].value){e.text(t[0].value);var n=t.datepicker("getDate");savemap[e[0].id]=n.getFullYear()+"-"+n.getMonth()+"-"+n.getDate(),$(this).parents(".modal").hide()}return!1}),$(document).on("click",".checkbox",function(){savemap[this.id]=this.checked}),$(".editable.link").each(function(){var e=this.id+"_url",t=this.id+"_text",n=this.id+"_focus",r=this.id+"_div",i="";linkCheck("url",e)&&(i=this.name);var s='<div class="modal" id="'+r+'">'+"<p>Text: "+'<input type="text" size="45" class="'+n+'" name="'+t+'" id="'+t+'" value="'+$(this).text()+'" /></p>'+"<p>Link:</p>"+'<br><input type="radio" name="'+e+'" value="url" '+linkCheck("url",e)+'><input type="text" id="'+e+'_val" value="'+i+'">'+$.tnm.pagelinks[this.id]+'<p><a class="close link" href="#">save</a> <a href="#" class="cancel">cancel</a></p></div>';$(this).after(s)}),$(document).on("click",".close.link",function(){var e=$(this).parents("div").first(),t=e.prev(),n=$("#"+t[0].id+"_url_val"),r=$("#"+t[0].id+"_text"),i=$("input[name="+t[0].id+"_url]:radio:checked");if(i[0].value!="url"||checkURL(n[0].value)){var s;i[0].value=="url"?s=n[0].value:s=i[0].value,t.text(r[0].value),savemap[r[0].id]=t.html(),savemap[t[0].id+"_url"]=s,$(this).parents(".modal").hide()}return!1}),$("a:has(img)").find(".editable.image").unwrap(),$(document).on("click",".imgclear",function(){var e=$(this).parents("div").first(),t=e.prev();return $(this).parents(".modal").hide(),stopImageEdit(),savemap[t[0].id+"_c"]=!0,!1}),$(document).on("click",".imgselect",function(){var e=$(this).parents("div").first(),t=e.prev(),n=$.tnm.imageurls[t[0].id];return savemap[t[0].id+"_b"]=$("#"+t[0].id+"_select")[0].value,!1}),$(document).keyup(function(e){e.keyCode==27&&($(".dialog").hide(),stopImageEdit())}),$(".editable").each(function(){var e=$('<div class="edithover"></div>'),t=$(this);e.attr("id",this.id+"_edit"),e.offset(t.offset()),e.width(t.outerWidth()),e.height(t.outerHeight()),$("body").append(e),$.data(e[0],"id",this.id),e.mouseout(function(){e.hide()}),e.mouseover(function(){e.show()}),t.mouseover(function(){e.show()});if(t.hasClass("line")){var n=$('<input type="text" value="'+t.html()+'" />');n.width(t.width()),n.height(t.height()),n.css("background",t.css("background")),n.css("background-color",t.css("background-color")),n.css("border",t.css("border")),n.css("color",t.css("color")),n.css("font-family",t.css("font-family")),n.css("font-size",t.css("font-size")),n.css("font-weight",t.css("font-weight")),n.css("margin",t.css("margin")),n.css("padding",t.css("padding")),n.css("text-transform",t.css("text-transform")),e.append(n)}else if(t.hasClass("image"))e.append('<a class="img-hover img-edit">edit</a>'),e.append('<a class="img-hover img-change" href="#">change</a>'),e.append('<a class="img-hover img-link">link</a>');else if(t.hasClass("social")){var n=this.id,r="";for(var i=0;i<$.tnm.social_media.length;i++){var s=$.tnm.social_media[i][0],o=$.tnm.social_media[i][1];r+='<li><input type="text" ng-model="socialmap[\''+s+'\']" " id="'+n+"_"+s+'" placeholder="'+o+' Profile URL"/><div class="social_icon '+s+'"></div></li>'}var u=make_dialog(this.id+"_dialog","Add/edit social networks","Social Networks","<ul>"+r+"</ul>","save_social");$(e).click(function(){u.show()})}});var r=make_dialog("image_change_dialog","Upload/change image","Change Image",'<iframe id="image_upload_iframe" src="#" style="visibility: hidden; display: none"></iframe><form method="POST" id="image_upload_form" target="image_upload_iframe" enctype="multipart/form-data"><input type="file" id="image_upload_file" name="file"></form>',"upload_image","upload");$(".img-hover.img-edit").click(function(e){var t=$.data($(this).parent()[0],"id");$(e.target).parent().hide(),$.tnm.edit_image_id=t;var n=$.tnm.imageurls[t];$("#containerimg").draggable({containment:"parent"}).css("background-image","url("+n.orig+")"),$("#imgcontainer").show(),loadimg(t),resize(0,{value:n.s}),e.preventDefault()}),$(".img-hover.img-change").click(function(e){var t=$.data($(this).parent()[0],"id");$.tnm.upload_image_id=t,$("#image_change_dialog").show(),e.preventDefault()})})